# Final Fantasy 風格 ATB RPG 遊戲 - 開發教學文件

## 目錄
1. [專案概覽](#專案概覽)
2. [如何執行](#如何執行)
3. [操作方式](#操作方式)
4. [架構設計](#架構設計)
5. [核心系統詳解](#核心系統詳解)
6. [各模組說明](#各模組說明)
7. [關鍵演算法](#關鍵演算法)
8. [擴展指南](#擴展指南)

---

## 專案概覽

本專案是一個純 HTML/CSS/JavaScript 實現的最終幻想風格 ATB（Active Time Battle）半即時回合制 RPG 遊戲 Demo。

**核心特色：**
- 3x3 九宮格戰鬥配置系統
- ATB 半即時回合制（Wait 模式）
- 地圖模式：4 方向移動，敵人巡邏/追擊
- 多方向戰鬥加入：戰鬥中敵人可從前/後/左/右方加入
- 零依賴、零構建工具，直接開啟 HTML 即可運行

**技術規格：**
- Canvas 渲染（960x640）
- ES Modules 模組化
- requestAnimationFrame 遊戲迴圈
- 程式繪製圖形（無需外部美術資源）

---

## 如何執行

1. 使用本地伺服器開啟 `index.html`（因為 ES Modules 需要 HTTP 服務）
   ```bash
   # 方法一：使用 VS Code Live Server 擴展
   # 方法二：使用 Python
   python -m http.server 8080
   # 方法三：使用 Node.js
   npx serve .
   ```
2. 在瀏覽器開啟 `http://localhost:8080`

---

## 操作方式

### 地圖模式
| 按鍵 | 功能 |
|------|------|
| ↑↓←→ 或 WASD | 4 方向移動 |
| 靠近敵人 | 觸發戰鬥 |

### 戰鬥模式
| 按鍵 | 功能 |
|------|------|
| ↑↓ | 選擇指令/目標 |
| Z / Enter | 確認選擇 |
| X / Escape | 取消/返回上一層 |

---

## 架構設計

### 檔案結構
```
GameDamo/
├── index.html                    # 入口頁面
├── css/style.css                 # 全域樣式
├── js/
│   ├── main.js                   # 啟動入口
│   ├── core/                     # 引擎核心
│   │   ├── Game.js               # 遊戲狀態機
│   │   ├── GameLoop.js           # 遊戲主迴圈
│   │   ├── InputManager.js       # 輸入管理
│   │   └── EventBus.js           # 事件系統
│   ├── map/                      # 地圖系統
│   │   ├── MapScene.js           # 地圖場景控制器
│   │   ├── TileMap.js            # 磁磚地圖
│   │   ├── MapPlayer.js          # 地圖玩家
│   │   ├── MapEnemy.js           # 地圖敵人
│   │   └── Camera.js             # 攝影機
│   ├── battle/                   # 戰鬥系統
│   │   ├── BattleScene.js        # 戰鬥場景控制器
│   │   ├── BattleGrid.js         # 3x3 九宮格
│   │   ├── BattleUnit.js         # 戰鬥單位
│   │   ├── ATBSystem.js          # ATB 計量系統
│   │   ├── SquadManager.js       # 多方向小隊管理
│   │   ├── BattleManager.js      # 戰鬥流程控制
│   │   ├── BattleAI.js           # 敵人 AI
│   │   └── BattleRenderer.js     # 戰鬥渲染
│   ├── ui/                       # UI 組件
│   │   ├── BattleHUD.js          # 戰鬥面板
│   │   ├── BattleMenu.js         # 指令選單
│   │   └── TargetSelector.js     # 目標選擇器
│   └── data/                     # 數據定義
│       ├── UnitDefinitions.js    # 單位屬性
│       ├── AbilityDefinitions.js # 技能定義
│       ├── MapData.js            # 地圖數據
│       └── EnemyFormations.js    # 敵人編隊
```

### 場景狀態機

```
LOADING → MAP ↔ BATTLE
              ↕ (TRANSITION)
```

`Game.js` 管理全域狀態，透過 `switchScene()` 和 `startTransition()` 在地圖與戰鬥間切換，切換時帶有淡入淡出效果。

---

## 核心系統詳解

### 1. 遊戲迴圈（GameLoop.js）

```javascript
_frame(timestamp) {
    const dt = Math.min(timestamp - this.lastTime, 50); // 上限 50ms 防止跳幀
    this.updateFn(dt);  // 更新邏輯
    this.renderFn();     // 渲染畫面
    requestAnimationFrame(this._frame);
}
```

使用 `requestAnimationFrame` 驅動，`dt` 為毫秒級 delta time，上限 50ms 防止長時間暫停後的巨大跳幀。

### 2. 輸入管理（InputManager.js）

追蹤三種狀態：
- `isDown(code)`: 按鍵持續按住
- `isJustPressed(code)`: 按鍵剛按下（本幀）
- `isJustReleased(code)`: 按鍵剛釋放（本幀）

每幀結束時呼叫 `clear()` 重設 justPressed/justReleased。

### 3. ATB 系統（ATBSystem.js）

**核心公式：**
```
fillRate = (unitSpeed / 255) * globalMultiplier * (dt / 16.67)
```

- `unitSpeed`: 單位速度屬性（60~140）
- 速度越高的角色 ATB 填充越快
- 當 ATB 值達到 100 時，單位可以行動
- **Wait 模式**: 玩家選擇指令時 ATB 暫停

### 4. 傷害公式

**物理傷害：**
```
damage = (攻擊力 × 技能倍率 × 2 × 前排加成 - 防禦力) × 後排減傷 × variance(0.9~1.1)
```

**魔法傷害：**
```
damage = ((魔力 + 法術威力) × 2 - 魔防) × variance(0.9~1.1)
```

### 5. 九宮格位置效果

```
Row 0（前排）: 物理攻擊 +20%
Row 1（中排）: 無加成
Row 2（後排）: 受物理傷害 -20%
魔法攻擊不受位置影響
```

---

## 各模組說明

### 地圖系統

#### TileMap.js
- 管理 30×20 的磁磚地圖
- 6 種磁磚類型：草地、牆壁、水、道路、樹木、橋
- 提供 `isWalkable()` 碰撞檢測
- 只渲染攝影機可見範圍內的磁磚（效能優化）

#### MapPlayer.js
- 4 方向格子移動 + 平滑位置插值
- 每次移動一個磁磚格子
- 移動前檢查目標格子是否可行走

#### MapEnemy.js
- **狀態機**: PATROL → CHASE → RETURNING → IN_BATTLE
- 偵測範圍 5 格，追擊範圍 7 格
- 巡邏時按預定路徑移動，到達路點後等待 1 秒
- 追擊時向玩家方向逐格移動
- **ATB 計時**: 戰鬥進行時，地圖上的敵人也在累積 ATB
- ATB 填滿後可加入正在進行的戰鬥

#### Camera.js
- 平滑跟隨玩家
- 夾到世界邊界內
- 使用指數平滑：`factor = 1 - (1 - smoothing)^(dt/16.67)`

### 戰鬥系統

#### BattleGrid.js
- 管理一個 3×3 的單位配置格
- 提供 place/remove/getUnits/getAliveUnits 操作

#### SquadManager.js
- 管理 5 個 BattleGrid：center（玩家）、front/back/left/right（敵人）
- 處理敵人增援的添加
- 提供全域查詢：所有玩家、所有敵人、是否有存活單位

#### BattleManager.js
**戰鬥狀態機：**
```
STARTING → RUNNING → PLAYER_MENU → PLAYER_TARGET → EXECUTING
                   ↓                                    ↓
              REINFORCEMENT                    VICTORY / DEFEAT
```

- RUNNING: ATB 填充，檢查就緒單位
- PLAYER_MENU: 暫停 ATB，等待玩家選擇指令
- PLAYER_TARGET: 等待玩家選擇目標
- EXECUTING: 執行動作動畫（300ms 延遲 + 300ms 結果）
- REINFORCEMENT: 敵人增援入場動畫

#### BattleRenderer.js
**戰鬥佈局：**
```
        [後方 back]         y: 100
[左方 left] [我方 center] [右方 right]  y: 250
        [前方 front]        y: 400
─────────────────────────────────
  HUD 面板                  y: 460~640
```

每個格子 44×44 像素，間距 2 像素。

### UI 系統

#### BattleHUD.js
- 左側顯示 4 個玩家角色的 HP/MP/ATB 條
- 右側顯示戰鬥日誌（最近 8 條）
- 活躍單位有高亮背景

#### BattleMenu.js
- 支援主選單 + 子選單（魔法/特技）
- 選項：攻擊、魔法、特技、偷竊、防禦
- ↑↓ 切換，Z 確認，X 取消

#### TargetSelector.js
- 在所有可選目標間切換
- 閃爍高亮當前目標
- 顯示目標名稱和 HP

---

## 關鍵演算法

### 敵人增援方向判定

```javascript
getDirectionRelativeToPlayer(playerTileX, playerTileY) {
    const dx = this.tileX - playerTileX;
    const dy = this.tileY - playerTileY;
    if (Math.abs(dx) > Math.abs(dy)) {
        return dx > 0 ? 'right' : 'left';
    } else {
        return dy > 0 ? 'front' : 'back';
    }
}
```

- 敵人在玩家下方 → 前方（front）
- 敵人在玩家上方 → 後方（back）
- 敵人在玩家左方 → 左方（left）
- 敵人在玩家右方 → 右方（right）

### 戰鬥中 ATB 累積

即使在戰鬥場景中，地圖上未參戰的敵人也會持續累積 ATB：

```javascript
// BattleManager._checkReinforcements()
for (const enemy of this.mapScene.enemies) {
    if (enemy.alive && enemy.state !== 'in_battle') {
        const fillRate = (enemy.atbSpeed / 255) * 0.8 * (dt / 16.67);
        enemy.atbValue = Math.min(enemy.atbMax, enemy.atbValue + fillRate);
    }
}
```

每 3 秒檢查一次是否有敵人 ATB 已滿，滿了就加入戰鬥。

---

## 擴展指南

### 新增職業
在 `UnitDefinitions.js` 的 `PLAYER_UNITS` 中添加新職業：
```javascript
knight: {
    name: '騎士',
    job: 'knight',
    hp: 400, mp: 30,
    attack: 40, defense: 50,
    magic: 8, magicDef: 25,
    speed: 70,
    color: '#c0392b',
    abilities: ['attack', 'shieldBash', 'defend'],
}
```

### 新增技能
在 `AbilityDefinitions.js` 的 `ABILITIES` 中添加：
```javascript
shieldBash: {
    name: '盾擊',
    type: 'physical',
    target: 'single_enemy',
    power: 1.3,
    mpCost: 5,
    description: '用盾牌猛擊敵人',
}
```

### 新增敵人類型
1. 在 `UnitDefinitions.js` 的 `ENEMY_UNITS` 中添加新敵人
2. 在 `EnemyFormations.js` 中添加對應的陣型
3. 在 `MapData.js` 的 `ENEMY_SPAWNS` 中添加生成點

### 擴大地圖
修改 `MapData.js` 中的 `MAP_TILES` 陣列和 `MAP_WIDTH`/`MAP_HEIGHT` 常數。

---

## 數據配置參考

### 玩家角色
| 職業 | HP | MP | 攻擊 | 防禦 | 魔力 | 魔防 | 速度 |
|------|-----|-----|------|------|------|------|------|
| 戰士 | 320 | 40 | 45 | 35 | 10 | 15 | 100 |
| 魔法師 | 180 | 150 | 15 | 15 | 50 | 40 | 85 |
| 盜賊 | 240 | 60 | 35 | 20 | 15 | 20 | 140 |
| 白魔導 | 200 | 180 | 12 | 20 | 45 | 45 | 90 |

### 敵人
| 類型 | HP | 攻擊 | 防禦 | 速度 | 經驗 | 金幣 |
|------|-----|------|------|------|------|------|
| 哥布林 | 120 | 25 | 12 | 95 | 15 | 10 |
| 骷髏兵 | 180 | 30 | 25 | 75 | 25 | 18 |
| 史萊姆 | 80 | 15 | 8 | 60 | 10 | 8 |
